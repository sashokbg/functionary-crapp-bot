<html>
  <head>
    <link rel="stylesheet" href="/styles.css" />
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>

    <div id="board">
    </div>

    Prompt:
    <textarea id="prompt" onkeydown="keyHandle(event)">
    </textarea>

    <button onClick="send()">Send</button>
    <button onClick="restart()" disabled>Restart</button>

    <script>
      const socket = io("http://localhost:5000");
      const messages = [];
      const promp = document.getElementById("prompt");
      const board = document.getElementById("board");

      const keyHandle = () => {
        if(event.keyCode == 13 && event.ctrlKey){
          send();
        }
      }

      const confirm = (element) => {
        socket.emit("confirm-message", {});
        element.disabled = true;
      }

      console.log("Prompt is", promp);

      socket.on("assistant-message", (data) => {
        console.log("assistant message received", data);
        messages.push({role: "assistant", "content": data.data.content})
        updateBoard();
      });

      socket.on("system-confirm", (data) => {
        console.log("confirm request received", data);
        messages.push({role: "system", "action": data.data.content.function_call.name, "content": JSON.parse(data.data.content.function_call.arguments)})
        updateBoard();
      });

      socket.on("system-message", (data) => {
        console.log("system message received", data);
        messages.push({role: "system", "content": data.data.content})
        updateBoard();
      });

      const restart = () => {
        socket.emit("restart-conversation");
      }

      const send = () => {
        const text = promp.value;
        console.log("Sending", text);

        socket.emit("client-message", text);
        messages.push({role: "user", "content": text})
        console.log("Messages", messages);
        updateBoard();
        promp.value = "";
      }

      const updateBoard = () => {

        let text = "";
        for(const message of messages) {
          if(message.action) {
            text += `<div class="system-message">
            <b>${message.role}</b>: The Assistant wants to perform the following action:
              <div>
                <b>Action</b>: ${message.action}
              </div>
              <div>
                <b>Data</b>: ${JSON.stringify(message.content)}
              </div>
              <div>
                <button onClick="confirm(this)">Confirm</button>
              </div>
            </div>
            `
          } else {
            text += `<p><b>${message.role}</b>: ${message.content}</p>`
          }
        }

        board.innerHTML = text;

        window.scrollTo(0, document.body.scrollHeight);
      }
    </script>

  </body>
</html>

